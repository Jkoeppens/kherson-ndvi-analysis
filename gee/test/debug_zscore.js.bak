// ğŸ”§ Debug-Parameter
var debugRegionKey = 'kherson';
var debugYear = 2023;

// ğŸ“ Region laden
var debugRegion = regionDefs[debugRegionKey];

// ğŸ“Š Statistik laden
var stats = getNDVIBaselineStats(debugRegionKey);
var mean = stats.mean;
var stdDev = stats.stdDev;

// ğŸ›¡ï¸ Z-Score-Bild mit Maske
var minStdDev = 0.01;
var validMask = stdDev.gte(minStdDev);

var z = loadNDVIAsset(debugRegionKey, debugYear)
          .subtract(mean)
          .divide(stdDev)
          .updateMask(validMask)
          .rename('NDVI_Z');

// ğŸ—ºï¸ Kartenansicht
Map.centerObject(debugRegion, 8);
var zClamped = z.clamp(config.zClampRange[0], config.zClampRange[1]);

Map.addLayer(zClamped, {
  min: config.zDisplayRange[0],
  max: config.zDisplayRange[1],
  palette: config.zPalette
}, 'Z-Score (clamped) â€“ ' + debugRegionKey + ' ' + debugYear);

// ğŸš« Zu niedrige Ïƒ-Werte
var lowStdMask = stdDev.lt(minStdDev).selfMask();
Map.addLayer(lowStdMask, {palette: ['black']}, 'âš ï¸ Ïƒ < ' + minStdDev);

// ğŸ“ˆ Histogramme
var zChart = ui.Chart.image.histogram(z, debugRegion, config.scale)
  .setOptions({
    title: 'Z-Wert-Verteilung â€“ ' + debugRegionKey + ' (' + debugYear + ')',
    hAxis: {title: 'Z-Wert'},
    vAxis: {title: 'Pixelanzahl'}
  });
print(zChart);

var stdChart = ui.Chart.image.histogram(stdDev, debugRegion, config.scale)
  .setOptions({
    title: 'Standardabweichung (Ïƒ) â€“ Baseline ' + debugRegionKey,
    hAxis: {title: 'Ïƒ'},
    vAxis: {title: 'Pixelanzahl'}
  });
print(stdChart);

// ğŸ”¬ Stichprobe: NDVI, Î¼, Ïƒ, Z
var ndvi = loadNDVIAsset(debugRegionKey, debugYear);
var composite = ndvi.addBands(mean).addBands(stdDev).addBands(z);
var sample = composite.sample({
  region: debugRegion,
  scale: config.scale,
  numPixels: 5,
  seed: 123,
  geometries: true
});
print('ğŸ“Š Stichprobe NDVI, Î¼, Ïƒ, Z (' + debugRegionKey + ', ' + debugYear + '):', sample);
